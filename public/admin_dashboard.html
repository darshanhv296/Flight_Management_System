<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Dashboard</title>

<style>
/* ‚úÖ Base Styling */
body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: url('bg.jpg') no-repeat center center/cover fixed;
  height: 100vh;
  color: white;
}

/* No overlay ‚Äî background always visible */
.overlay {
  display: none;
}

/* Dashboard layout */
.dashboard {
  position: relative;
  z-index: 2;
  display: flex;
  height: 100%;
}

/* ‚úÖ Sidebar with slight transparency and glow */
.sidebar {
  width: 260px;
  background: rgba(0, 0, 0, 0.7);
  box-shadow: 2px 0 20px rgba(0,180,216,0.4);
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

/* Sidebar title with glow */
.sidebar h2 {
  color: #00b4d8;
  text-align: center;
  margin-bottom: 30px;
  text-shadow: 0 0 8px rgba(0,180,216,0.8);
}

/* ‚úÖ Glowing Buttons */
.sidebar button {
  background: #00b4d8;
  color: black;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 10px rgba(0,180,216,0.5);
  width: 100%;
  font-size: 16px;
}

/* Glowing hover animation */
.sidebar button:hover {
  background: #0090b0;
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(0,180,216,0.8);
}

/* ‚úÖ Logout Button Special Styling */
.logout-btn {
  background: crimson;
  color: white;
  margin-top: auto;
  box-shadow: 0 0 10px rgba(220,20,60,0.6);
}
.logout-btn:hover {
  background: #a80000;
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(220,20,60,0.8);
}

/* ‚úÖ Main content area */
.content {
  flex-grow: 1;
  padding: 30px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.5); /* subtle transparency for contrast */
  box-shadow: inset 0 0 20px rgba(0,180,216,0.2);
}

/* Section title */
h1 {
  text-align: center;
  color: #00b4d8;
  text-shadow: 0 0 10px rgba(0,180,216,0.8);
}
</style>


</head>
<body>
<div class="overlay"></div>
<div class="dashboard">

  <div class="sidebar">
    <h2>Admin Panel</h2>
    <button class="btn" onclick="window.location.href='bookings.html'">üìã View All Bookings</button>
    <button onclick="openPage('admin_flight.html')">‚úàÔ∏è Flights</button>
    <button onclick="openPage('registration.html')">üë• Registrations</button>
    <button onclick="openPage('admin_pay.html')">üí≥ Payments</button>
    
    
    <button onclick="logout()">üö™ Logout</button>
  
  </div>

  <div class="content">
    <h1>Welcome, Admin</h1>
    <div id="dashboard-stats">
      <h2>System Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Bookings</h3>
          <p id="total-bookings">Loading...</p>
        </div>
        <div class="stat-card">
          <h3>Active Users</h3>
          <p id="active-users">Loading...</p>
        </div>
        <div class="stat-card">
          <h3>Recent Bookings</h3>
          <div id="recent-bookings">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  padding: 20px;
}

.stat-card {
  background: rgba(0, 0, 0, 0.7);
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0, 180, 216, 0.3);
  border: 1px solid #00b4d8;
}

.stat-card h3 {
  color: #00b4d8;
  margin-top: 0;
}

#recent-bookings {
  max-height: 200px;
  overflow-y: auto;
}

.booking-item {
  padding: 10px;
  border-bottom: 1px solid rgba(0, 180, 216, 0.3);
  font-size: 0.9em;
}

.booking-item:last-child {
  border-bottom: none;
}
</style>

<script>
// Keep track of event source
let bookingStream = null;

// Initialize SSE connection
function initializeEventSource() {
  if (bookingStream) {
    bookingStream.close();
  }
  
  bookingStream = new EventSource('/bookings/stream');
  
  bookingStream.onmessage = (event) => {
    const bookings = JSON.parse(event.data);
    updateDashboard(bookings);
  };
  
  bookingStream.onerror = (error) => {
    console.error('SSE Error:', error);
    bookingStream.close();
    setTimeout(initializeEventSource, 5000); // Retry after 5s
  };
}

// Update dashboard with new data
async function updateDashboard(bookings = []) {
  // Update total bookings
  document.getElementById('total-bookings').textContent = bookings.length;
  
  // Get active users
  try {
    const userRes = await fetch('/admin/users');
    const userData = await userRes.json();
    if (userData.success) {
      document.getElementById('active-users').textContent = userData.users.length;
    }
  } catch (err) {
    console.error('Error fetching users:', err);
  }
  
  // Update recent bookings
  const recentBookingsDiv = document.getElementById('recent-bookings');
  const recentBookings = bookings
    .slice(0, 5)
    .map(booking => {
      const reason = booking.cancelReason || booking.reason || '';
      const reasonHtml = reason ? `<div style="font-size:0.85em;color:#ffb347;margin-top:6px;">Reason: ${reason}</div>` : '';
      return `
      <div class="booking-item">
        <strong>${booking.ticket_id}</strong><br>
        ${booking.username || 'Guest'} - ${booking.flight_name}<br>
        ${booking.source} ‚úàÔ∏è ${booking.destination}
        ${reasonHtml}
      </div>
    `}).join('');
  
  recentBookingsDiv.innerHTML = recentBookings || 'No recent bookings';
}

// Initial load and setup periodic updates
async function loadInitialData() {
  try {
    // First try auto-login if needed
    await checkAutoLogin();

    // Then verify admin session
    const sessionCheck = await fetch('/info', {
      credentials: 'include',
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    const sessionData = await sessionCheck.json();
    
    if (sessionData.role !== 'admin') {
      // No admin session even after auto-login attempt
      window.location.href = 'index.html';
      return;
    }

    const res = await fetch('/api/bookings', {
      credentials: 'include',
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    const data = await res.json();
    if (data.success) {
      updateDashboard(data.bookings);
    }
  } catch (err) {
    console.error('Error loading data:', err);
  }
}

// Set up periodic updates without page refresh
document.addEventListener('DOMContentLoaded', () => {
  // Initial load
  loadInitialData();
  initializeEventSource();
  
  // Set up periodic session checks without forced redirects
  setInterval(async () => {
    try {
      const sessionCheck = await fetch('/info', {
        credentials: 'include',
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      const data = await sessionCheck.json();
      if (data.role !== 'admin') {
        console.warn('Session status changed - admin access may be limited');
      }
    } catch (err) {
      console.warn('Session check error:', err);
    }
  }, 30000); // Check session more frequently - every 30 seconds
  
  // Update data every 30 seconds
  setInterval(() => {
    loadInitialData();
  }, 30000);
});

// Page navigation
function openPage(page) {
  // mark origin so opened pages can return here via their Home buttons
  try { sessionStorage.setItem('origin', 'admin'); } catch(e) {}
  window.location.href = page;
}

// Logout with proper role handling
async function logout() {
  if (!confirm('Are you sure you want to logout?')) return;
  
  // Close SSE connection
  if (bookingStream) {
    bookingStream.close();
  }

  try {
    // Specify admin role in logout
    await fetch('/logout?role=admin', {
      method: 'POST',
      credentials: 'include'
    });
    
    // Clean up storage
    try { sessionStorage.removeItem('origin'); } catch(e) {}
    localStorage.clear();
    
    // Redirect to login
    window.location.replace('index.html');
  } catch (err) {
    console.error('Logout error:', err);
    alert('Error during logout. Please try again.');
  }
}

// Cleanup on page unload
window.onbeforeunload = () => {
  if (bookingStream) {
    bookingStream.close();
  }
};
</script>

</body>
</html>
