<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="30">
<title>Registered Users | JARVIS Admin Panel</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: url('bg.jpg') center/cover no-repeat fixed;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 20px;
    position: relative; /* needed for absolute button positioning */
  }

  h1 {
    font-size: 2rem;
    color: #00b4d8;
    text-shadow: 0 0 10px #00b4d8;
    margin-bottom: 20px;
  }

  table {
    width: 90%;
    margin: 30px auto;
    border-collapse: collapse;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 180, 216, 0.3);
  }

  th, td {
    border: 1px solid rgba(0, 180, 216, 0.3);
    padding: 12px;
  }

  th {
    background-color: #00b4d8;
    color: #000;
    font-weight: bold;
  }

  tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.08);
  }

  tr:hover {
    background-color: rgba(0, 180, 216, 0.2);
    transition: 0.3s;
  }

  button {
    padding: 7px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
  }

  .delete-btn {
    background-color: #ff4d4d;
    color: white;
  }

  .delete-btn:hover {
    background-color: #e63946;
  }

  #loading {
    font-size: 1.2rem;
    color: #00b4d8;
    text-shadow: 0 0 8px #00b4d8;
  }

  .hidden-password {
    letter-spacing: 3px;
    color: #ccc;
  }

  .success-message,
  .error-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 30px;
    border-radius: 8px;
    font-weight: bold;
    animation: slideDown 0.3s ease-out;
    z-index: 1000;
  }

  .success-message {
    background-color: rgba(0, 200, 0, 0.9);
    color: white;
  }

  .error-message {
    background-color: rgba(255, 0, 0, 0.9);
    color: white;
  }

  @keyframes slideDown {
    from { top: -50px; opacity: 0; }
    to { top: 20px; opacity: 1; }
  }

  /* Top-right back button */
  .back-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    background: #00b4d8;
    color: black;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    z-index: 1000;
  }

  .back-btn:hover {
    background: #0096c7;
  }
</style>
</head>

<body>
  <button class="back-btn" onclick="goBack()">â¬… Back to Dashboard</button>
  <h1>ðŸ‘‘ Registered Users</h1>
  <div id="loading">Loading user details...</div>

  <table id="userTable" style="display:none;">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Password</th>
        <th>Role</th>
        <th>Created At</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadUsers() {
      try {
        // Check admin status first
        const authRes = await fetch("/info", { credentials: "include" });
        const authData = await authRes.json();
        
        if (!authData.role || authData.role !== "admin") {
          window.location.href = "index.html"; // Redirect to login if not admin
          return;
        }

        const res = await fetch("/admin/users", { credentials: "include" });
        const data = await res.json();

        const loading = document.getElementById("loading");
        const table = document.getElementById("userTable");

        if (data.success) {
          const tbody = document.querySelector("#userTable tbody");
          tbody.innerHTML = "";

          data.users.forEach(u => {
            const hiddenPass = "â€¢".repeat(8); // mask password
            const row = `
              <tr>
                <td>${u.user_id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td class="hidden-password">${hiddenPass}</td>
                <td>${u.role}</td>
                <td>${new Date(u.created_at).toLocaleString()}</td>
                <td>
                  <button class="delete-btn" onclick="deleteUser('${u.user_id}', '${u.username}')">Delete</button>
                </td>
              </tr>`;
            tbody.innerHTML += row;
          });

          loading.style.display = "none";
          table.style.display = "table";
        } else {
          loading.innerHTML = "âŒ Failed to load users: " + data.error;
          if (data.error === "Unauthorized") {
            setTimeout(() => window.location.href = "index.html", 2000);
          }
        }
      } catch (err) {
        console.error("Error fetching users:", err);
        document.getElementById("loading").innerText = "âš ï¸ Error loading users.";
        setTimeout(() => loadUsers(), 5000); // Retry after 5 seconds
      }
    }

    async function deleteUser(id, username) {
      if (!confirm(`âš ï¸ Are you sure you want to delete user '${username}'? This cannot be undone!`)) return;

      try {
        const res = await fetch(`/admin/users/${id}`, {
          method: "DELETE",
          credentials: "include"
        });

        const data = await res.json();

        if (data.success) {
          const successMsg = document.createElement('div');
          successMsg.className = 'success-message';
          successMsg.textContent = `âœ… User '${username}' deleted successfully.`;
          document.body.appendChild(successMsg);
          
          setTimeout(() => {
            successMsg.remove();
            loadUsers(); // refresh table
          }, 2000);
        } else {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          errorMsg.textContent = "âŒ Failed to delete user: " + data.error;
          document.body.appendChild(errorMsg);
          
          setTimeout(() => {
            errorMsg.remove();
            if (data.error === "Unauthorized") {
              window.location.href = "index.html";
            }
          }, 2000);
        }
      } catch (err) {
        console.error("Delete error:", err);
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = "âš ï¸ An error occurred while deleting user.";
        document.body.appendChild(errorMsg);
        setTimeout(() => errorMsg.remove(), 2000);
      }
    }

    function goBack() {
      window.location.href = "admin_dashboard.html";
    }

    // Load users when page opens
    window.onload = loadUsers;
  </script>
</body>
</html>
